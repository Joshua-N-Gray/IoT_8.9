#include <WiFi.h>
#include <WiFiClient.h>
#include <HTTPClient.h>
#include <stdio.h>
#include <time.h>

// Define WiFi credentials
char ssid[] = "UU-IoT";
char pass[] = "0xDEADBEEF";

// Define the PIR sensor pin and related variables
const int sensorPin = 14;
int state = 0;
int awayHomeMode = 1;

void setup() {

  pinMode(sensorPin, INPUT);  // Set PIR sensor pin as input
  Serial.begin(115200);           // Start serial communication at 115200 baud rate for debugging

  // Api Calling Setup
    Serial.begin(115200);
    WiFi.begin(ssid, pass);
    while (WiFi.status() != WL_CONNECTED) {
      delay(1000);
      Serial.println("Connecting to WiFi...");
    }
    Serial.println("Connected to WiFi");
}

void loop() {

  HTTPClient http;
  const char* api_url = "https://prod-05.centralus.logic.azure.com:443/workflows/ae00a049dd8546c5b033c88487666fb9/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=ctFFp92UVNUhsS9SuYiI5TcJ6v9dihHqJrh66GMCbvM";
  const char* subscription_key = "1b4c7bde7691450ea424c9ed91230c17";
 
  if (awayHomeMode == 1) {
    state = digitalRead(sensorPin);  // Read the state of the PIR sensor

    Serial.print("state:");
    Serial.println(state);

    // If the sensor detects movement, send an alert
    if (state == HIGH) {
      Serial.println("Somebody here!");

      time_t now = time(NULL);
      struct tm *t = localtime(&now);

      Serial.printf("Local time: %s", asctime(t));

      http.begin(api_url);

      http.POST("\"name\":\"camera_1\",\"date\":\"12/10/25:4:12pm\",\"location\":\"The HUB\"");

      http.end();

    }
  }
  delay(2000);
}
